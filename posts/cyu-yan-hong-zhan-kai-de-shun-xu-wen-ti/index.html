<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>C语言宏展开的顺序问题 - 编程研讨会</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C语言宏展开的顺序问题" />
<meta property="og:description" content="C语言宏展开的顺序问题 本文记录了作者遇到的一个关于C语言宏展开顺序的问题及其解释。 问题 这是我在阅读The C Puzzle Book一书中遇到的一个问题，为了简化问题，我写了以下一段代码 #include &lt;stdio.h&gt;#define TEST(x) x*5 #define PR(x) printf(#x &#34; = %d&#34;, x) #define PRINT1(x) PR(x);printf(&#34;\n&#34;) #define" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/cyu-yan-hong-zhan-kai-de-shun-xu-wen-ti/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-03-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-02-19T23:47:24+08:00" />


		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="C语言宏展开的顺序问题"/>
<meta name="twitter:description" content="C语言宏展开的顺序问题 本文记录了作者遇到的一个关于C语言宏展开顺序的问题及其解释。 问题 这是我在阅读The C Puzzle Book一书中遇到的一个问题，为了简化问题，我写了以下一段代码 #include &lt;stdio.h&gt;#define TEST(x) x*5 #define PR(x) printf(#x &#34; = %d&#34;, x) #define PRINT1(x) PR(x);printf(&#34;\n&#34;) #define"/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/highlighter-pygments-monokai.css"><link rel="stylesheet" href="/css/asciidoctor.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程研讨会" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程研讨会</div>
					<div class="logo__tagline">技术修炼，个人成长，读书思考，不止于编程。</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">菜单</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">首页</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">分类</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">标签</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">关于</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/talk/">
				
				<span class="menu__text">分享</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/archives/">
				
				<span class="menu__text">归档</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>

		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C语言宏展开的顺序问题</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">赵裕(vimerzhao)</span>
</div>
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2017-03-14T00:00:00Z">2017-03-14</time>
	<time class="meta__text" datetime="2022-02-19T23:47:24&#43;08:00">(最后修改: 2022-02-19)</time></div></div>
		</header>
        <span style="color:grey; font-size: 0.9em">本文约 800 字，阅读需 2 分钟。</span><p /><div class="content post__content clearfix">
			<h1 id="c语言宏展开的顺序问题">C语言宏展开的顺序问题</h1>
<p>本文记录了作者遇到的一个关于C语言宏展开顺序的问题及其解释。</p>
<h2 id="问题">问题</h2>
<p>这是我在阅读<em>The C Puzzle Book</em>一书中遇到的一个问题，为了简化问题，我写了以下一段代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#define TEST(x) x*5
</span><span style="color:#75715e">#define PR(x) printf(#x &#34; = %d&#34;, x)
</span><span style="color:#75715e">#define PRINT1(x) PR(x);printf(&#34;\n&#34;)
</span><span style="color:#75715e">#define PRINT2(x) printf(#x &#34; = %d\n&#34;, x)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span> argv[]) {
    PRINT1(TEST(<span style="color:#ae81ff">2</span>));
    PRINT2(TEST(<span style="color:#ae81ff">2</span>));
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>输出为:</p>
<pre tabindex="0"><code>2*5 = 10
TEST(2) = 10
</code></pre><p>**问题：**如果先替换外面的，则第一行展开顺序为:</p>
<pre tabindex="0"><code>PRINT1(TEST(2));
PR(TEST(2)); printf(&quot;\n&quot;);
printf(#TEST(2) &quot; = %d&quot;, TEST(2)); printf(&quot;\n&quot;);
printf(&quot;TEST(2)&quot; &quot; = %d&quot;, 2*5); printf(&quot;\n&quot;);
TEST(2) = 10
</code></pre><p>但显然不是；同理，如果先替换里面的:</p>
<pre tabindex="0"><code>PRINT2(TEST(2));
PRINT2(2*5);
printf(#2*5 &quot; = %d&quot;, 2*5);
printf(&quot;2*5&quot; &quot; = %d&quot;, 2*5);
2*5 = 10
</code></pre><p>这样又与第二行输出矛盾了!</p>
<h2 id="解释">解释</h2>
<p>在翻阅了<em>C Primer Plus</em>以及<em>K&amp;R C</em>之后并没有找到解释，但Google但StackOverflow上一个<a href="http://stackoverflow.com/questions/8754593/macro-evaluation-order">类似问题</a>。顺藤摸瓜找到对应的文档，终于发现原因！首先我就先入为主，做了一个错误的假设：把带参数的宏当函数一样理解！其实不然，预处理器是按<code>token</code>进行处理的，也就是说<code>PR(x)</code>对于预处理器来说就是一些符号,和<code>x*x</code>这种没有本质区别。
再参考文档中这段描述:</p>
<blockquote>
<p>Macro arguments are completely macro-expanded before they are substituted into a macro body, unless they are stringized or pasted with other tokens. After substitution, the entire macro body, including the substituted arguments, is scanned again for macros to be expanded. The result is that the arguments are scanned twice to expand macro calls in them.</p>
</blockquote>
<p>可以知道只有对于<code>#</code>和<code>##</code>处理的参数不做替换，其他的预处理器根本不知道是什么，只是会再扫描一遍，如果又发现了宏则继续替换！所以以上代码的替换过程应该大致如下:</p>
<pre tabindex="0"><code>PRINT1(TEST(2));
PR(2*5); printf(&quot;\n&quot;);
printf(#2*5 &quot; = %d&quot;); printf(&quot;\n&quot;);
printf(&quot;2*5&quot; &quot; = %d&quot;); printf(&quot;\n&quot;);
2*5 = 10        // 第一行
PRINT2(TEST(2))；
printf(#TEST(2) &quot; = %d\n&quot;, 2*5);
printf(&quot;TEST(2)&quot; &quot; = %d\n&quot;, 2*5);
TEST(2) = 10    // 第二行
</code></pre><p>其实，仔细想想，本质就是:</p>
<pre tabindex="0"><code>#define PR(x) printf(#x &quot; = %d\n&quot;, x)
</code></pre><p>只不过多了一次带参数宏调用，不知道是不是自己走火入魔了，如果不是的话感觉这个代码也可以当谜题收录到<em>The C Puzzle Book</em>里面去了！
还有就是Google+StackOverflow比baidu+CSDN强大得真不是一点点！<strong>遇到问题最可靠的还是看文档而不是琢磨别人的解释，而有时候要找到对的文档就需要从StackOverflow这样的高质量社区顺藤摸瓜。</strong></p>
<h2 id="参考">参考</h2>
<ol>
<li><a href="http://stackoverflow.com/questions/8754593/macro-evaluation-order">c++ - Macro evaluation order - Stack Overflow</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/cpp/Argument-Prescan.html#Argument-Prescan">The C Preprocessor: Argument Prescan</a></li>
</ol>

		</div>

        <p/><span id="wc" style="color:grey; font-size: 0.9em">本页阅读量<span id="busuanzi_value_page_pv"></span>次。</span>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2016nian-zhong-zong-jie/" rel="prev">
			<span class="pager__subtitle">«&thinsp;上一篇</span>
			<p class="pager__title">2016年终总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cyu-yan-zhong-bu-dai-de-dai-ma-kuai/" rel="next">
			<span class="pager__subtitle">下一篇&thinsp;»</span>
			<p class="pager__title">&#39;C语言中不带{}的代码块&#39;</p>
		</a>
	</div>
</nav>

<script src="https://utteranc.es/client.js"
        repo="vimerzhao/vimerzhao.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


			</div>
			<aside class="sidebar"><div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="搜索…" value="" name="q" aria-label="搜索…">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="/" />
	</form>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">近期文章</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/change-input-method-with-left-shift/">定制Mac的输入法切换按键为左Shift</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/developing-cpp-with-android-sutdio/">Android Sutdio开发C&#43;&#43;项目踩坑记录</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/improve-efficiency-by-shuangpin/">如何提高中文输入的效率</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/try-to-use-english-everywhere/">日常开发尽量使用英文</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/thinking-about-vim-and-emacs/">现阶段（2021年10月）对于Vim和Emacs的思考</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/thinking-about-past-one-year/">关于过去一年的思考（2020/9～2021/9）</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/fix-a-serious-flutter-engine-multithread-bug/">抽丝剥茧：Flutter Engine隐藏的一个惊天Bug</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/flutter-nested-scroll-conflict/">大道至简：Flutter嵌套滑动冲突解决之路</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/record-a-flutter-platform-view-bug/">Flutter PlatformView大小异常导致闪退锁屏</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/configure-hugo-asciidoc-blog/">Hugo&#43;Asciidoc配置记录</a></li>
		</ul>
	</div>
</div>
<div class="widget-categories widget">
	<h4 class="widget__title">分类</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item">
				<a class="widget__link" href="/categories/android/">Android</a>&nbsp;
				<span class="widget__counter widget__counter--bubble">8</span>
				</li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/flutter/">Flutter</a>&nbsp;
				<span class="widget__counter widget__counter--bubble">1</span>
				</li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">标签</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/bugfix/" title="BugFix">BugFix (14)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E5%B7%A5%E5%85%B7/" title="工具">工具 (27)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/" title="工程实践">工程实践 (6)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E5%BC%80%E5%8F%91%E6%80%9D%E8%80%83/" title="开发思考">开发思考 (3)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E6%80%BB%E7%BB%93/" title="总结">总结 (7)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E6%8A%80%E6%9C%AF%E7%B2%BE%E9%80%89/" title="技术精选">技术精选 (10)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="源码剖析">源码剖析 (12)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E7%AC%94%E8%AE%B0/" title="笔记">笔记 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" title="读书笔记">读书笔记 (11)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E8%BD%AF%E6%8A%80%E8%83%BD/" title="软技能">软技能 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%E9%9A%8F%E7%AC%94/" title="随笔">随笔 (15)</a>
	</div>
</div>
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">社交</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/vimerzhao" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>

		
	</div>
</div>
</aside>
		</div>
		
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5f402244ea199b9952086dd1313a204d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2022 编程研讨会.
			<span class="footer__copyright-credits">基于 <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> 引擎和 <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> 主题</span>
		</div>
	</div>
	<div class="container footer__container">
        <span id="busuanzi_container_site_pv">
            本站访问量：<span id="busuanzi_value_site_pv"></span>次，
        </span>
        <span id="busuanzi_container_site_uv">
            您是本站第 <span id="busuanzi_value_site_uv"></span> 位访问者
        </span>
	</div>
</footer>

	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>